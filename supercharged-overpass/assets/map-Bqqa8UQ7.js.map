{"version":3,"file":"map-Bqqa8UQ7.js","sources":["../../js/map.ts"],"sourcesContent":["// escape strings to show them directly in the html.\nimport $ from \"jquery\";\nimport \"leaflet\";\n\n// include the CSS files\nimport \"leaflet/dist/leaflet.css\";\nimport \"../css/map.css\";\n\nimport configs from \"./configs\";\nimport overpass from \"./overpass\";\nimport Query from \"./query\";\nimport {parseUrlParameters} from \"./urlParameters\";\n\n$(document).ready(() => {\n  // main map cache\n  const cache = {};\n\n  window.addEventListener(\n    \"message\",\n    async (evt) => {\n      const data = typeof evt.data === \"string\" ? JSON.parse(evt.data) : {};\n      if (data.cmd === \"update_map\") {\n        settings.code[\"overpass\"] = data.value[0];\n        ide.update_map();\n      } else if (data.cmd === \"cache\") {\n        settings.code[\"overpass\"] = data.value[0];\n        const query = await ide.getQuery();\n        const query_lang = ide.getQueryLang();\n        overpass.run_query(\n          query,\n          query_lang,\n          cache,\n          true,\n          undefined,\n          undefined,\n          ide.mapcss\n        );\n      }\n    },\n    false\n  );\n\n  // some initalizations\n  $.fn.dialog = function () {\n    alert(`error :( ${$(this).html()}`);\n  };\n  configs.appname = \"overpass-ide-map\";\n  const settings = {\n    code: {},\n    server: configs.defaultServer,\n    tileServer: configs.defaultTiles,\n    silent: false,\n    force_simple_cors_request: true,\n    disable_poiomatic: false\n  };\n  const ide = {\n    map: undefined as unknown as L.Map,\n    mapcss: \"\",\n    async getQuery(): Promise<string> {\n      let query = settings.code[\"overpass\"];\n      const queryParser = new Query();\n      query = await queryParser.parse(query, {});\n      // parse mapcss declarations\n      let mapcss = \"\";\n      if (queryParser.hasStatement(\"style\"))\n        mapcss = queryParser.getStatement(\"style\");\n      ide.mapcss = mapcss;\n      // parse data-source statements\n      let data_source = null;\n      if (queryParser.hasStatement(\"data\")) {\n        data_source = queryParser.getStatement(\"data\");\n        data_source = data_source.split(\",\");\n        const data_mode = data_source[0].toLowerCase();\n        data_source = data_source.slice(1);\n        const options = {};\n        for (const src of data_source) {\n          const tmp = src.split(\"=\");\n          options[tmp[0]] = tmp[1];\n        }\n        data_source = {\n          mode: data_mode,\n          options: options\n        };\n      }\n      ide.data_source = data_source;\n      // remove newlines\n      query = query.trim();\n\n      return query;\n    },\n    getQueryLang() {\n      return $.trim(settings.code[\"overpass\"]).match(/^</)\n        ? \"xml\"\n        : \"OverpassQL\";\n    },\n    async update_map() {\n      $(\"#data_stats\").remove();\n      if (typeof overpass.osmLayer != \"undefined\")\n        ide.map.removeLayer(overpass.osmLayer);\n      const query = await ide.getQuery();\n      const query_lang = ide.getQueryLang();\n      overpass.run_query(\n        query,\n        query_lang,\n        cache,\n        false,\n        undefined,\n        undefined,\n        ide.mapcss\n      );\n      $(\"#map_blank\").remove();\n    }\n  };\n  overpass.init();\n  // (very raw) compatibility check\n  if ($.support.cors != true || false) {\n    // the currently used browser is not capable of running the IDE. :(\n    $(\n      '<div title=\"Your browser is not supported :(\">' +\n        '<p>The browser you are currently using, is not capable of running this Application. <small>It has to support <a href=\"http://en.wikipedia.org/wiki/Cross-origin_resource_sharing\">cross origin resource sharing (CORS)</a>.</small></p>' +\n        '<p>Please update to a more up-to-date version of your browser or switch to a more capable browser! Recent versions of <a href=\"http://www.opera.com\">Opera</a>, <a href=\"http://www.google.com/intl/de/chrome/browser/\">Chrome</a> and <a href=\"http://www.mozilla.org/de/firefox/\">Firefox</a> have been tested to work.</p>' +\n        \"</div>\"\n    ).dialog({modal: true});\n  }\n  // check for any get-parameters\n  const params = parseUrlParameters();\n  // uncompressed query set in url\n  settings.code[\"overpass\"] = params.get(\"Q\");\n  // don't alert on overpass errors, but send messages to parent window\n  settings.silent = params.has(\"silent\");\n  // init leaflet\n  ide.map = new L.Map(\"map\");\n  const tilesUrl = settings.tileServer;\n  const tilesAttrib = configs.tileServerAttribution;\n  const tiles = new L.TileLayer(tilesUrl, {attribution: tilesAttrib});\n  ide.map.setView([0, 0], 1).addLayer(tiles);\n  const scaleControl = new L.Control.Scale({metric: true, imperial: false});\n  scaleControl.addTo(ide.map);\n  // wait spinner\n  $(document).on({\n    ajaxStart() {\n      $(\"#loading-dialog\").addClass(\"is-active\");\n    },\n    ajaxStop() {\n      $(\"#loading-dialog\").removeClass(\"is-active\");\n    }\n  });\n  ide.map.on(\"layeradd\", (e) => {\n    if (!(e.layer instanceof L.GeoJSON)) return;\n    ide.map.setView([0, 0], 18, true);\n    try {\n      ide.map.fitBounds(e.layer.getBounds());\n    } catch (err) {}\n  });\n  // overpass functionality\n  overpass.handlers[\"onEmptyMap\"] = (empty_msg) => {\n    $(\n      `<div id=\"map_blank\" style=\"z-index:700; display:block; position:absolute; top:50px; width:100%; text-align:center; background-color:#eee; opacity: 0.8;\">This map intentionally left blank. <small>(${empty_msg})</small></div>`\n    ).appendTo(\"#map\");\n  };\n  if (settings.silent) {\n    overpass.handlers[\"onAjaxError\"] = (errmsg) => {\n      parent.postMessage(\n        JSON.stringify({handler: \"onAjaxError\", msg: errmsg}),\n        \"*\"\n      );\n    };\n    overpass.handlers[\"onQueryError\"] = (errmsg) => {\n      parent.postMessage(\n        JSON.stringify({handler: \"onQueryError\", msg: errmsg}),\n        \"*\"\n      );\n    };\n  } else {\n    overpass.handlers[\"onAjaxError\"] = (errmsg) => {\n      alert(\n        `An error occured during the execution of the overpass query!\\n${errmsg}`\n      );\n    };\n    overpass.handlers[\"onQueryError\"] = (errmsg) => {\n      alert(\n        `An error occured during the execution of the overpass query!\\nThis is what overpass API returned:\\n${errmsg}`\n      );\n    };\n  }\n  overpass.handlers[\"onGeoJsonReady\"] = () => {\n    ide.map.addLayer(overpass.osmLayer);\n  };\n  overpass.handlers[\"onPopupReady\"] = (p) => {\n    p.openOn(ide.map);\n  };\n  overpass.handlers[\"onDataReceived\"] = (\n    amount,\n    txt,\n    elements,\n    abortCB,\n    continueCB\n  ) => {\n    continueCB();\n  };\n  overpass.handlers[\"onRawDataPresent\"] = () => {\n    parent.postMessage(\n      JSON.stringify({\n        query: settings.code[\"overpass\"],\n        resultType: overpass.resultType,\n        resultText: overpass.resultText\n      }),\n      \"*\"\n    );\n  };\n  // load the data\n  ide.update_map();\n});\n"],"names":["$","cache","evt","data","settings","ide","query","query_lang","overpass","configs","queryParser","Query","mapcss","data_source","data_mode","options","src","tmp","params","parseUrlParameters","tilesUrl","tilesAttrib","tiles","empty_msg","errmsg","p","amount","txt","elements","abortCB","continueCB"],"mappings":"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"}